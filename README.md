
# NixOS flake

This repo contains a flake-based NixOS configuration intended to be reused across multiple machines.

## Install / switch

1) Clone this repo onto the target machine.

2) Generate host hardware config (first time on a machine):

```bash
sudo nixos-generate-config --show-hardware-config > hosts/<host>/hardware-configuration.nix
```

Replace `<host>` with one of the flake hosts (see `hosts/`).

3) Build and switch:

```bash
sudo nixos-rebuild switch --flake .#<host>
```

Examples:

```bash
sudo nixos-rebuild switch --flake .#laptop
sudo nixos-rebuild switch --flake .#desktop
```

Optional: verify evaluation/build without switching:

```bash
nix flake show
sudo nixos-rebuild build --flake .#<host>
```

## Folder structure rules

- `flake.nix`
  - Entry point.
  - `nixosConfigurations.<host>` defines the supported hosts.

- `configuration.nix`
  - Shared (host-agnostic) NixOS configuration.
  - Must NOT import any host-specific `hardware-configuration.nix`.
  - Put global services/users/packages here (or in `modules/`).

- `hosts/<host>/`
  - Per-host modules only.
  - `hosts/<host>/default.nix` is the host entry module (imported by `flake.nix`).
  - `hosts/<host>/hardware-configuration.nix` is generated by `nixos-generate-config` and contains disks/filesystems/kernel module detection.
  - `hosts/<host>/graphics.nix` contains GPU/video driver settings for that host.

- `modules/`
  - Reusable NixOS modules shared by multiple hosts.
  - Keep these hardware-agnostic (no disk UUIDs, no PCI bus IDs) unless the module is explicitly host-specific and lives under `hosts/<host>/`.

- `home/`
  - Home Manager integration.
  - `home/default.nix` wires Home Manager into the NixOS config.
  - `home/modules/` contains reusable HM modules.

## flakeHost usage

`flakeHost` is injected into all modules via `specialArgs` in `flake.nix`.
Use it to keep host-specific logic inside shared modules.

Example (NixOS module):

```nix
{ lib, flakeHost, ... }:

lib.mkIf (flakeHost == "desktop") {
  services.openssh.enable = true;
}
```

Example (HM override with host-specific files):

```nix
{ lib, flakeHost, ... }:

let
  desktopConfig =
    builtins.readFile ../../home/modules/niri/config.kdl
    + "\n\n"
    + builtins.readFile ../../home/modules/niri/desktop-outputs.kdl;
in
lib.mkIf (flakeHost == "desktop") {
  home-manager.users.ktvsky.xdg.configFile."niri/config.kdl" =
    lib.mkForce { text = desktopConfig; };
}
```

## Notes

- Root-level `hardware-configuration.nix` is intentionally not used; host configs live under `hosts/<host>/`.
