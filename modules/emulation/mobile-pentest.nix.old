{ config, pkgs, lib, ... }:

let
  # Android SDK composition
  androidComposition = pkgs.androidenv.composeAndroidPackages {
    platformVersions = [ "34" ];
    abiVersions = [ "x86_64" ];
    systemImageTypes = [ "google_apis" ];
    includeEmulator = true;
    includeSystemImages = true;
    includeNDK = true;
    includeSources = false;
    includeExtras = [ "extras;google;google_play_services" ];
  };

  androidSdk = androidComposition.androidsdk;
  
  # Frida version
  fridaVersion = "16.5.9";
  
  # Download Frida server
  fridaServer = pkgs.fetchurl {
    url = "https://github.com/frida/frida/releases/download/${fridaVersion}/frida-server-${fridaVersion}-android-x86_64.xz";
    sha256 = "0djf7j55ygm7mazqjbbf4j8y29csv8kln68dciv8mwf1nmzi574r";
  };
  
  # Download Magisk APK
  magiskApk = pkgs.fetchurl {
    url = "https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk";
    sha256 = "sha256-9RG9M9MkKRHQWwk5+RCjEz7yug4P8eCYEo+fPNDBZhA=";
  };

  # AVD configuration
  avdName = "Pixel_8_API_34";
  avdDevice = "pixel_8";
  
  # Clean Android emulator wrapper
  android-clean = pkgs.writeShellScriptBin "android" ''
    export ANDROID_HOME="${androidSdk}/libexec/android-sdk"
    export ANDROID_SDK_ROOT="$ANDROID_HOME"
    export ANDROID_AVD_HOME="$HOME/.android/avd"
    
    # Create AVD if it doesn't exist
    if [ ! -d "$ANDROID_AVD_HOME/${avdName}.avd" ]; then
      echo "Creating AVD: ${avdName}..."
      echo "no" | ${androidSdk}/libexec/android-sdk/cmdline-tools/latest/bin/avdmanager create avd \
        --name "${avdName}" \
        --package "system-images;android-34;google_apis;x86_64" \
        --device "${avdDevice}" \
        --force
      
      # Configure AVD for better performance
      cat >> "$ANDROID_AVD_HOME/${avdName}.avd/config.ini" <<EOF
    hw.keyboard=yes
    hw.ramSize=4096
    hw.gpu.enabled=yes
    hw.gpu.mode=auto
    disk.dataPartition.size=4096M
    EOF
    fi
    
    # Launch emulator
    echo "Starting clean Android emulator..."
    ${pkgs.steam-run}/bin/steam-run \
      ${androidSdk}/libexec/android-sdk/emulator/emulator \
      -avd "${avdName}" \
      -gpu auto \
      -no-snapshot-save \
      "$@"
  '';

  # Rooted Android emulator with Frida and Magisk
  android-rooted = pkgs.writeShellScriptBin "android-root" ''
    export ANDROID_HOME="${androidSdk}/libexec/android-sdk"
    export ANDROID_SDK_ROOT="$ANDROID_HOME"
    export ANDROID_AVD_HOME="$HOME/.android/avd"
    export PATH="${androidSdk}/libexec/android-sdk/platform-tools:$PATH"
    
    AVD_NAME="${avdName}_rooted"
    
    # Create rooted AVD if it doesn't exist
    if [ ! -d "$ANDROID_AVD_HOME/''${AVD_NAME}.avd" ]; then
      echo "Creating rooted AVD: ''${AVD_NAME}..."
      echo "no" | ${androidSdk}/libexec/android-sdk/cmdline-tools/latest/bin/avdmanager create avd \
        --name "''${AVD_NAME}" \
        --package "system-images;android-34;google_apis;x86_64" \
        --device "${avdDevice}" \
        --force
      
      # Configure AVD
      cat >> "$ANDROID_AVD_HOME/''${AVD_NAME}.avd/config.ini" <<EOF
    hw.keyboard=yes
    hw.ramSize=4096
    hw.gpu.enabled=yes
    hw.gpu.mode=auto
    disk.dataPartition.size=4096M
    fastboot.forceColdBoot=no
    EOF
    fi
    
    # Launch emulator with root access
    echo "Starting rooted Android emulator..."
    ${pkgs.steam-run}/bin/steam-run \
      ${androidSdk}/libexec/android-sdk/emulator/emulator \
      -avd "''${AVD_NAME}" \
      -writable-system \
      -selinux disabled \
      -gpu auto \
      -no-snapshot-save \
      "$@" &
    
    EMULATOR_PID=$!
    
    # Wait for emulator to boot
    echo "Waiting for emulator to boot..."
    ${androidSdk}/libexec/android-sdk/platform-tools/adb wait-for-device
    sleep 10
    
    # Check if emulator is fully booted
    while [ "$(${androidSdk}/libexec/android-sdk/platform-tools/adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')" != "1" ]; do
      echo "Waiting for boot to complete..."
      sleep 2
    done
    
    echo "Emulator booted. Setting up root access..."
    
    # Enable root and remount system
    ${androidSdk}/libexec/android-sdk/platform-tools/adb root
    sleep 2
    ${androidSdk}/libexec/android-sdk/platform-tools/adb remount
    sleep 2
    
    # Extract and install Frida server
    FRIDA_SETUP_FLAG="$ANDROID_AVD_HOME/''${AVD_NAME}.avd/.frida_installed"
    if [ ! -f "$FRIDA_SETUP_FLAG" ]; then
      echo "Installing Frida server..."
      FRIDA_TMP=$(mktemp -d)
      ${pkgs.xz}/bin/xz -d -c ${fridaServer} > "$FRIDA_TMP/frida-server"
      
      ${androidSdk}/libexec/android-sdk/platform-tools/adb push "$FRIDA_TMP/frida-server" /data/local/tmp/frida-server
      ${androidSdk}/libexec/android-sdk/platform-tools/adb shell "chmod 755 /data/local/tmp/frida-server"
      
      # Start Frida server in background
      ${androidSdk}/libexec/android-sdk/platform-tools/adb shell "nohup /data/local/tmp/frida-server > /dev/null 2>&1 &"
      
      rm -rf "$FRIDA_TMP"
      touch "$FRIDA_SETUP_FLAG"
      echo "Frida server installed and started."
    else
      echo "Frida already installed. Starting Frida server..."
      ${androidSdk}/libexec/android-sdk/platform-tools/adb shell "nohup /data/local/tmp/frida-server > /dev/null 2>&1 &"
    fi
    
    # Install Magisk
    MAGISK_SETUP_FLAG="$ANDROID_AVD_HOME/''${AVD_NAME}.avd/.magisk_installed"
    if [ ! -f "$MAGISK_SETUP_FLAG" ]; then
      echo "Installing Magisk..."
      ${androidSdk}/libexec/android-sdk/platform-tools/adb install -r ${magiskApk}
      touch "$MAGISK_SETUP_FLAG"
      echo "Magisk installed."
    else
      echo "Magisk already installed."
    fi
    
    echo ""
    echo "================================================"
    echo "Rooted Android emulator is ready!"
    echo "- Frida server running on port 27042"
    echo "- Magisk installed"
    echo "- Root access enabled"
    echo "================================================"
    echo ""
    
    # Keep script running until emulator exits
    wait $EMULATOR_PID
  '';

in
{
  # Accept Android SDK license
  nixpkgs.config.android_sdk.accept_license = true;
  nixpkgs.config.allowUnfree = true;

  # Enable ADB system-wide
  programs.adb.enable = true;

  # System packages
  environment.systemPackages = with pkgs; [
    androidSdk
    android-clean      # Clean Android emulator wrapper
    android-rooted     # Rooted Android emulator wrapper
    
    # Additional tools for Android development
    jdk17
    python3
    frida-tools        # Frida Python tools (corrected package name)
    xz
  ];

  # Hardware acceleration for emulator
  boot.kernelModules = [ "kvm-intel" ];  # Use "kvm-amd" for AMD CPUs
  
  # Environment variables
  environment.variables = {
    ANDROID_HOME = "${androidSdk}/libexec/android-sdk";
    ANDROID_SDK_ROOT = "${androidSdk}/libexec/android-sdk";
  };

  # Optional: Enable virtualization
  virtualisation.libvirtd.enable = true;
}

